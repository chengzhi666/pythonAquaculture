<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ°´äº§å…»æ®–æƒ…æŠ¥é‡‡é›†ä¸åˆ†æç³»ç»Ÿ</title>
<style>
/* â”€â”€ å…¨å±€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root {
  --primary: #1677ff;
  --primary-hover: #4096ff;
  --success: #52c41a;
  --error: #ff4d4f;
  --warning: #faad14;
  --bg: #f5f7fa;
  --card: #ffffff;
  --border: #e8e8e8;
  --text: #333;
  --text-secondary: #888;
  --radius: 8px;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: -apple-system, "Microsoft YaHei", "PingFang SC", sans-serif;
  background: var(--bg); color: var(--text);
  min-height: 100vh;
}

/* â”€â”€ å¤´éƒ¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.header {
  background: linear-gradient(135deg, #1677ff 0%, #0958d9 100%);
  color: #fff; padding: 20px 32px; display: flex;
  align-items: center; justify-content: space-between;
  box-shadow: 0 2px 8px rgba(0,0,0,.15);
}
.header h1 { font-size: 22px; font-weight: 600; }
.header .stats-bar { display: flex; gap: 18px; font-size: 13px; opacity: .9; }
.header .stats-bar span { background: rgba(255,255,255,.18); padding: 4px 12px; border-radius: 12px; }

/* â”€â”€ Tab é¡µç­¾ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tabs { display: flex; border-bottom: 2px solid var(--border); background: var(--card); padding: 0 32px; }
.tab-btn {
  padding: 14px 28px; cursor: pointer; border: none; background: none;
  font-size: 15px; color: var(--text-secondary); position: relative; transition: .2s;
}
.tab-btn.active { color: var(--primary); font-weight: 600; }
.tab-btn.active::after {
  content: ''; position: absolute; bottom: -2px; left: 0; right: 0;
  height: 2px; background: var(--primary);
}

/* â”€â”€ é€šç”¨å®¹å™¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.container { max-width: 1300px; margin: 0 auto; padding: 24px 32px; }
.tab-content { display: none; }
.tab-content.active { display: block; }

/* â”€â”€ å¡ç‰‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card {
  background: var(--card); border-radius: var(--radius);
  box-shadow: 0 1px 4px rgba(0,0,0,.08); padding: 24px; margin-bottom: 20px;
}
.card h3 { font-size: 16px; margin-bottom: 16px; color: var(--text); display: flex; align-items: center; gap: 8px; }

/* â”€â”€ è¡¨å• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.form-row { display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap; }
.form-group { display: flex; flex-direction: column; gap: 6px; }
.form-group label { font-size: 13px; color: var(--text-secondary); font-weight: 500; }
.form-group input, .form-group select {
  padding: 8px 14px; border: 1px solid var(--border); border-radius: 6px;
  font-size: 14px; outline: none; transition: .2s; min-width: 180px;
}
.form-group input:focus, .form-group select:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(22,119,255,.15); }

.btn {
  padding: 9px 24px; border: none; border-radius: 6px; cursor: pointer;
  font-size: 14px; font-weight: 500; transition: .2s; white-space: nowrap;
}
.btn-primary { background: var(--primary); color: #fff; }
.btn-primary:hover { background: var(--primary-hover); }
.btn-primary:disabled { opacity: .55; cursor: not-allowed; }
.btn-outline { background: #fff; border: 1px solid var(--border); color: var(--text); }
.btn-outline:hover { border-color: var(--primary); color: var(--primary); }

/* â”€â”€ æç¤ºæ¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tips { background: #fffbe6; border: 1px solid #ffe58f; border-radius: 6px; padding: 10px 16px; font-size: 13px; color: #ad6800; margin-bottom: 16px; line-height: 1.7; }
.tips b { color: #d46b08; }

/* â”€â”€ çŠ¶æ€æ ‡ç­¾ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.status-badge {
  display: inline-block; padding: 3px 10px; border-radius: 10px; font-size: 12px; font-weight: 500;
}
.status-pending  { background: #f0f0f0; color: #888; }
.status-running  { background: #e6f4ff; color: #1677ff; }
.status-done     { background: #f6ffed; color: #52c41a; }
.status-error    { background: #fff2f0; color: #ff4d4f; }

/* â”€â”€ ä»»åŠ¡åˆ—è¡¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.task-list { max-height: 260px; overflow-y: auto; }
.task-item {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 0; border-bottom: 1px solid #f5f5f5; font-size: 13px;
}
.task-item:last-child { border-bottom: none; }
.task-meta { display: flex; gap: 14px; align-items: center; }

/* â”€â”€ æ•°æ®è¡¨æ ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: 13px; }
th { background: #fafafa; padding: 10px 12px; text-align: left; font-weight: 600; border-bottom: 2px solid var(--border); position: sticky; top: 0; z-index: 1; }
td { padding: 9px 12px; border-bottom: 1px solid #f5f5f5; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
tr:hover td { background: #fafafa; }
td a { color: var(--primary); text-decoration: none; }
td a:hover { text-decoration: underline; }
.no-data { text-align: center; padding: 40px; color: var(--text-secondary); }

/* â”€â”€ ç»“æœç»Ÿè®¡æ¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.result-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.result-bar .count { font-size: 14px; color: var(--text-secondary); }

/* â”€â”€ åŠ è½½åŠ¨ç”» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid var(--primary); border-top-color: transparent; border-radius: 50%; animation: spin .8s linear infinite; vertical-align: middle; margin-right: 6px; }
@keyframes spin { to { transform: rotate(360deg); } }

/* â”€â”€ å“åº”å¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 768px) {
  .form-row { flex-direction: column; }
  .container { padding: 16px; }
  .header { flex-direction: column; gap: 10px; padding: 16px; }
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• å¤´éƒ¨ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="header">
  <h1>ğŸŸ æ°´äº§å…»æ®–æƒ…æŠ¥é‡‡é›†ä¸åˆ†æç³»ç»Ÿ</h1>
  <div class="stats-bar" id="statsBar">åŠ è½½ä¸­...</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Tab é¡µç­¾ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tabs">
  <button class="tab-btn active" data-tab="collect">ğŸ“¥ æ•°æ®é‡‡é›†</button>
  <button class="tab-btn" data-tab="papers">ğŸ“„ è®ºæ–‡æ•°æ®</button>
  <button class="tab-btn" data-tab="products">ğŸ›’ å•†å“æ•°æ®</button>
  <button class="tab-btn" data-tab="intel">ğŸ“‹ æ¸”ä¸šæ”¿ç­–</button>
</div>

<div class="container">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• é‡‡é›†é¡µ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-content active" id="tab-collect">
  <div class="card">
    <h3>âš™ï¸ å¯åŠ¨é‡‡é›†ä»»åŠ¡</h3>
    <div class="tips">
      <b>ä½¿ç”¨æç¤ºï¼š</b><br>
      â— <b>çŸ¥ç½‘(CNKI)</b>ï¼šæµè§ˆå™¨ä¼šå¼¹å‡ºï¼Œéœ€æ‰‹åŠ¨å®Œæˆæ»‘å—éªŒè¯åè‡ªåŠ¨ç»§ç»­é‡‡é›†<br>
      â— <b>äº¬ä¸œ(JD)</b>ï¼šæµè§ˆå™¨ä¼šå¼¹å‡ºï¼Œéœ€æ‰‹æœºæ‰«ç ç™»å½•åè‡ªåŠ¨ç»§ç»­é‡‡é›†<br>
      â— <b>æ·˜å®(Taobao)</b>ï¼šéœ€æå‰è¿è¡Œ <code>refresh_taobao_cookie.py</code> è·å– Cookie<br>
      â— <b>å†œä¸šå†œæ‘éƒ¨(MOA)</b>ï¼šæ— éœ€é¢å¤–æ“ä½œï¼Œç›´æ¥é‡‡é›†
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>çˆ¬è™«é€‰æ‹©</label>
        <select id="crawlerSelect">
          <option value="cnki">ğŸ“„ çŸ¥ç½‘è®ºæ–‡ (CNKI)</option>
          <option value="jd">ğŸ›’ äº¬ä¸œå•†å“ (JD)</option>
          <option value="taobao">ğŸ›ï¸ æ·˜å®å•†å“ (Taobao)</option>
          <option value="moa">ğŸ“‹ å†œä¸šå†œæ‘éƒ¨æ¸”ä¸šæ”¿ç­– (MOA)</option>
        </select>
      </div>
      <div class="form-group">
        <label>å…³é”®è¯</label>
        <input type="text" id="keywordInput" placeholder="å¦‚ï¼šä¸‰æ–‡é±¼ã€å¤§é»„é±¼ã€è™¹é³Ÿ..." value="ä¸‰æ–‡é±¼">
      </div>
      <div class="form-group">
        <label>é¡µæ•° / æ•°é‡</label>
        <input type="number" id="pagesInput" min="1" max="50" value="1" style="min-width:80px;">
      </div>
      <button class="btn btn-primary" id="startCrawlBtn" onclick="startCrawl()">ğŸš€ å¼€å§‹é‡‡é›†</button>
    </div>
  </div>

  <div class="card">
    <h3>ğŸ“‹ ä»»åŠ¡è®°å½•</h3>
    <div class="task-list" id="taskList">
      <div class="no-data">æš‚æ— ä»»åŠ¡</div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• è®ºæ–‡æ•°æ® â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-content" id="tab-papers">
  <div class="card">
    <h3>ğŸ” æŸ¥è¯¢è®ºæ–‡</h3>
    <div class="form-row">
      <div class="form-group">
        <label>å…³é”®è¯ï¼ˆæ ‡é¢˜/æ‘˜è¦/å…³é”®è¯ï¼‰</label>
        <input type="text" id="paperKeyword" placeholder="ç•™ç©ºæ˜¾ç¤ºå…¨éƒ¨">
      </div>
      <div class="form-group">
        <label>æ•°é‡é™åˆ¶</label>
        <input type="number" id="paperLimit" min="1" max="500" value="50" style="min-width:80px;">
      </div>
      <button class="btn btn-primary" onclick="queryPapers()">æŸ¥ è¯¢</button>
    </div>
  </div>
  <div class="card">
    <div class="result-bar">
      <span class="count" id="paperCount"></span>
    </div>
    <div class="table-wrap" id="paperTable"><div class="no-data">è¯·å…ˆè¿›è¡ŒæŸ¥è¯¢</div></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• å•†å“æ•°æ® â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-content" id="tab-products">
  <div class="card">
    <h3>ğŸ” æŸ¥è¯¢å•†å“</h3>
    <div class="form-row">
      <div class="form-group">
        <label>å…³é”®è¯ï¼ˆæ ‡é¢˜/æœç´¢è¯ï¼‰</label>
        <input type="text" id="prodKeyword" placeholder="ç•™ç©ºæ˜¾ç¤ºå…¨éƒ¨">
      </div>
      <div class="form-group">
        <label>å¹³å°</label>
        <select id="prodPlatform">
          <option value="">å…¨éƒ¨</option>
          <option value="taobao">æ·˜å®</option>
          <option value="jd">äº¬ä¸œ</option>
        </select>
      </div>
      <div class="form-group">
        <label>æ•°é‡é™åˆ¶</label>
        <input type="number" id="prodLimit" min="1" max="500" value="50" style="min-width:80px;">
      </div>
      <button class="btn btn-primary" onclick="queryProducts()">æŸ¥ è¯¢</button>
    </div>
  </div>
  <div class="card">
    <div class="result-bar">
      <span class="count" id="prodCount"></span>
    </div>
    <div class="table-wrap" id="prodTable"><div class="no-data">è¯·å…ˆè¿›è¡ŒæŸ¥è¯¢</div></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• æ¸”ä¸šæ”¿ç­– â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-content" id="tab-intel">
  <div class="card">
    <h3>ğŸ” æŸ¥è¯¢æ¸”ä¸šæ”¿ç­–</h3>
    <div class="form-row">
      <div class="form-group">
        <label>å…³é”®è¯ï¼ˆæ ‡é¢˜/å†…å®¹ï¼‰</label>
        <input type="text" id="intelKeyword" placeholder="ç•™ç©ºæ˜¾ç¤ºå…¨éƒ¨">
      </div>
      <div class="form-group">
        <label>æ•°é‡é™åˆ¶</label>
        <input type="number" id="intelLimit" min="1" max="500" value="50" style="min-width:80px;">
      </div>
      <button class="btn btn-primary" onclick="queryIntel()">æŸ¥ è¯¢</button>
    </div>
  </div>
  <div class="card">
    <div class="result-bar">
      <span class="count" id="intelCount"></span>
    </div>
    <div class="table-wrap" id="intelTable"><div class="no-data">è¯·å…ˆè¿›è¡ŒæŸ¥è¯¢</div></div>
  </div>
</div>

</div><!-- .container -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• JS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
/* â”€â”€ Tab åˆ‡æ¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
  });
});

/* â”€â”€ ç»Ÿè®¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadStats() {
  try {
    const r = await fetch('/api/stats');
    const d = await r.json();
    document.getElementById('statsBar').innerHTML =
      `<span>ğŸ“„ è®ºæ–‡ ${d.paper_meta || 0}</span>` +
      `<span>ğŸ›’ å•†å“ ${d.product_snapshot || 0}</span>` +
      `<span>ğŸ“‹ æ”¿ç­– ${d.intel_item || 0}</span>` +
      `<span>ğŸ“¦ åŸå§‹äº‹ä»¶ ${d.raw_event || 0}</span>`;
  } catch(e) {
    document.getElementById('statsBar').textContent = 'ç»Ÿè®¡åŠ è½½å¤±è´¥';
  }
}
loadStats();

/* â”€â”€ çˆ¬è™«æè¿°æ˜ å°„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const CRAWLER_LABELS = {
  cnki: 'çŸ¥ç½‘è®ºæ–‡', jd: 'äº¬ä¸œå•†å“', taobao: 'æ·˜å®å•†å“', moa: 'å†œä¸šå†œæ‘éƒ¨'
};
const STATUS_LABELS = {
  pending:  ['ç­‰å¾…ä¸­',  'pending'],
  running:  ['é‡‡é›†ä¸­â€¦', 'running'],
  done:     ['å®Œæˆ',    'done'],
  error:    ['å¤±è´¥',    'error'],
};

/* â”€â”€ ä»»åŠ¡è®°å½• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const tasks = [];  // {id, crawler, keyword, status, result, ...}
let pollingIds = new Set();

function renderTasks() {
  const el = document.getElementById('taskList');
  if (tasks.length === 0) { el.innerHTML = '<div class="no-data">æš‚æ— ä»»åŠ¡</div>'; return; }
  el.innerHTML = tasks.map(t => {
    const [label, cls] = STATUS_LABELS[t.status] || ['æœªçŸ¥', 'pending'];
    return `<div class="task-item">
      <div class="task-meta">
        <span class="status-badge status-${cls}">${t.status === 'running' ? '<span class="spinner"></span>' : ''}${label}</span>
        <span><b>${CRAWLER_LABELS[t.crawler] || t.crawler}</b></span>
        <span>å…³é”®è¯: ${t.keyword || '-'}</span>
      </div>
      <div style="color:var(--text-secondary);font-size:12px;">${t.result || ''}</div>
    </div>`;
  }).join('');
}

async function pollTask(taskId) {
  if (pollingIds.has(taskId)) return;
  pollingIds.add(taskId);
  const poll = async () => {
    try {
      const r = await fetch('/api/task/' + taskId);
      const d = await r.json();
      const idx = tasks.findIndex(t => t.id === taskId);
      if (idx >= 0) Object.assign(tasks[idx], d);
      renderTasks();
      if (d.status === 'running' || d.status === 'pending') {
        setTimeout(poll, 2000);
      } else {
        pollingIds.delete(taskId);
        loadStats();
      }
    } catch(e) {
      pollingIds.delete(taskId);
    }
  };
  poll();
}

async function startCrawl() {
  const crawler = document.getElementById('crawlerSelect').value;
  const keyword = document.getElementById('keywordInput').value.trim();
  const pages = parseInt(document.getElementById('pagesInput').value) || 1;

  if (!keyword && crawler !== 'moa') { alert('è¯·è¾“å…¥å…³é”®è¯'); return; }

  const btn = document.getElementById('startCrawlBtn');
  btn.disabled = true; btn.textContent = 'å¯åŠ¨ä¸­...';

  try {
    const r = await fetch('/api/crawl', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({crawler, keyword, pages}),
    });
    const d = await r.json();
    if (d.error) { alert(d.error); return; }
    tasks.unshift({id: d.task_id, crawler, keyword, status: 'pending', result: null});
    renderTasks();
    pollTask(d.task_id);
  } catch(e) {
    alert('å¯åŠ¨å¤±è´¥: ' + e.message);
  } finally {
    btn.disabled = false; btn.textContent = 'ğŸš€ å¼€å§‹é‡‡é›†';
  }
}

/* â”€â”€ é€šç”¨è¡¨æ ¼æ¸²æŸ“ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderTable(containerId, columns, rows) {
  const el = document.getElementById(containerId);
  if (!rows || rows.length === 0) { el.innerHTML = '<div class="no-data">æš‚æ— æ•°æ®</div>'; return; }
  let html = '<table><thead><tr>';
  columns.forEach(c => html += `<th>${c.label}</th>`);
  html += '</tr></thead><tbody>';
  rows.forEach(row => {
    html += '<tr>';
    columns.forEach(c => {
      let val = row[c.key] ?? '';
      if (c.isLink && val) val = `<a href="${val}" target="_blank">é“¾æ¥</a>`;
      if (c.maxLen && typeof val === 'string' && val.length > c.maxLen)
        val = `<span title="${val.replace(/"/g,'&quot;')}">${val.substring(0, c.maxLen)}â€¦</span>`;
      html += `<td>${val}</td>`;
    });
    html += '</tr>';
  });
  html += '</tbody></table>';
  el.innerHTML = html;
}

/* â”€â”€ è®ºæ–‡æŸ¥è¯¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function queryPapers() {
  const kw = document.getElementById('paperKeyword').value.trim();
  const limit = document.getElementById('paperLimit').value;
  const params = new URLSearchParams({keyword: kw, limit});
  try {
    const r = await fetch('/api/query/papers?' + params);
    const d = await r.json();
    document.getElementById('paperCount').textContent = `å…± ${d.count} æ¡ç»“æœ`;
    renderTable('paperTable', [
      {key:'id', label:'ID'},
      {key:'theme', label:'ä¸»é¢˜'},
      {key:'title', label:'æ ‡é¢˜', maxLen: 60},
      {key:'authors', label:'ä½œè€…', maxLen: 30},
      {key:'source', label:'æ¥æº'},
      {key:'pub_date', label:'å‘è¡¨æ—¥æœŸ'},
      {key:'abstract', label:'æ‘˜è¦', maxLen: 80},
      {key:'keywords_json', label:'å…³é”®è¯', maxLen: 40},
      {key:'url', label:'é“¾æ¥', isLink: true},
      {key:'fetched_at', label:'é‡‡é›†æ—¶é—´'},
    ], d.data);
  } catch(e) { alert('æŸ¥è¯¢å¤±è´¥: ' + e.message); }
}

/* â”€â”€ å•†å“æŸ¥è¯¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function queryProducts() {
  const kw = document.getElementById('prodKeyword').value.trim();
  const platform = document.getElementById('prodPlatform').value;
  const limit = document.getElementById('prodLimit').value;
  const params = new URLSearchParams({keyword: kw, platform, limit});
  try {
    const r = await fetch('/api/query/products?' + params);
    const d = await r.json();
    document.getElementById('prodCount').textContent = `å…± ${d.count} æ¡ç»“æœ`;
    renderTable('prodTable', [
      {key:'id', label:'ID'},
      {key:'platform', label:'å¹³å°'},
      {key:'keyword', label:'æœç´¢è¯'},
      {key:'title', label:'å•†å“åç§°', maxLen: 50},
      {key:'price', label:'ä»·æ ¼(Â¥)'},
      {key:'original_price', label:'åŸä»·'},
      {key:'sales_or_commit', label:'é”€é‡/è¯„ä»·'},
      {key:'shop', label:'åº—é“º', maxLen: 20},
      {key:'province', label:'çœä»½'},
      {key:'city', label:'åŸå¸‚'},
      {key:'detail_url', label:'é“¾æ¥', isLink: true},
      {key:'snapshot_time', label:'é‡‡é›†æ—¶é—´'},
    ], d.data);
  } catch(e) { alert('æŸ¥è¯¢å¤±è´¥: ' + e.message); }
}

/* â”€â”€ æ”¿ç­–æŸ¥è¯¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function queryIntel() {
  const kw = document.getElementById('intelKeyword').value.trim();
  const limit = document.getElementById('intelLimit').value;
  const params = new URLSearchParams({keyword: kw, limit});
  try {
    const r = await fetch('/api/query/intel?' + params);
    const d = await r.json();
    document.getElementById('intelCount').textContent = `å…± ${d.count} æ¡ç»“æœ`;
    renderTable('intelTable', [
      {key:'id', label:'ID'},
      {key:'source_type', label:'æ¥æºç±»å‹'},
      {key:'title', label:'æ ‡é¢˜', maxLen: 60},
      {key:'pub_time', label:'å‘å¸ƒæ—¶é—´'},
      {key:'org', label:'å‘å¸ƒæœºæ„', maxLen: 30},
      {key:'region', label:'åŒºåŸŸ'},
      {key:'content', label:'å†…å®¹', maxLen: 100},
      {key:'source_url', label:'é“¾æ¥', isLink: true},
      {key:'fetched_at', label:'é‡‡é›†æ—¶é—´'},
    ], d.data);
  } catch(e) { alert('æŸ¥è¯¢å¤±è´¥: ' + e.message); }
}
</script>
</body>
</html>
